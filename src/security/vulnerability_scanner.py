from __future__ import annotations

import os
from dataclasses import dataclass, asdict
from typing import Dict, List


@dataclass
class Finding:
    file: str
    line: int
    severity: str
    rule: str
    message: str

    def to_dict(self) -> Dict:
        return asdict(self)


RISKY_PATTERNS = [
    ("exec(", "high", "PY001", "Use of exec can lead to code execution vulnerabilities"),
    ("eval(", "high", "PY002", "Use of eval can lead to code execution vulnerabilities"),
    ("pickle.load(", "medium", "PY003", "Untrusted pickle loading can execute arbitrary code"),
    ("subprocess.Popen(", "medium", "PY004", "Check shell=True usage and input sanitization"),
]


class VulnerabilityScanner:
    """Very lightweight pattern-based scanner.

    Works without external tools; optional deep scanners can be added behind flags.
    """

    def __init__(self, root: str = "."):
        self.root = root

    def scan(self) -> List[Finding]:
        findings: List[Finding] = []
        for dirpath, _, filenames in os.walk(self.root):
            # Skip typical large or irrelevant dirs
            if any(p in dirpath for p in (".git", "node_modules", "__pycache__", ".venv", ".pytest_cache")):
                continue
            for fname in filenames:
                if not fname.endswith(".py"):
                    continue
                path = os.path.join(dirpath, fname)
                try:
                    with open(path, "r", encoding="utf-8", errors="ignore") as f:
                        for idx, line in enumerate(f, start=1):
                            for pat, sev, rule, msg in RISKY_PATTERNS:
                                if pat in line:
                                    findings.append(Finding(path, idx, sev, rule, msg))
                except Exception:
                    # Ignore unreadable files
                    continue
        return findings

